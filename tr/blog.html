<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
    <title>Space - Prompter</title>
    <base href="../" />
    <link rel="manifest" href="manifest.json?v=66" />
    <meta name="theme-color" content="#000000" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="description" content="Creative AI prompt generator that requires an internet connection." />
    <meta name="keywords" content="AI prompts, prompt generator, creative prompts, AI prompter, prompt maker" />
    <meta name="robots" content="index,follow" />
    <meta property="og:title" content="Space - Prompter" />
    <meta property="og:description" content="Creative AI prompt generator that requires an internet connection." />
    <meta property="og:image" content="/icons/logo.svg?v=66" />
    <meta property="og:image:alt" content="Prompter logo" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Space - Prompter" />
    <meta name="twitter:description" content="Creative AI prompt generator that requires an internet connection." />
    <meta name="twitter:image" content="/icons/logo.svg?v=66" />
    <meta property="og:url" content="https://prompterai.space/" />
    <meta property="og:site_name" content="Prompter" />
    <meta property="og:locale" content="tr" />
<meta property="og:locale:alternate" content="en" />
    <meta property="og:locale:alternate" content="es" />
    <meta property="og:locale:alternate" content="zh" />
    <meta property="og:locale:alternate" content="fr" />
    <meta property="og:locale:alternate" content="hi" />

    <meta name="twitter:url" content="https://prompterai.space/" />
    <script type="module" src="src/lucide-loader.js?v=66"></script>
    <link rel="stylesheet" href="css/tailwind.css?v=66" />
    <link rel="stylesheet" href="css/app.css?v=66" />
    <script type="module" src="src/init-app.js?v=66"></script>
    <script nomodule src="dist/init-app.js?v=66"></script>
    <link id="theme-css" rel="stylesheet" href="css/theme-dark.css?v=66" />
    <script>
      (function () {
        const linkEl = document.getElementById('theme-css');
        if (!linkEl) return;
        const version = linkEl.getAttribute('href').split('?')[1];
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          linkEl.href = `css/theme-${savedTheme}.css${
            version ? `?${version}` : ''
          }`;
        }
      })();
    </script>
    <script type="module" src="src/version.js?v=66"></script>
  </head>
  <body class="min-h-screen p-4">
    <div id="loading-screen">
      <div class="spinner" aria-label="Yükleniyor"></div>
    </div>
    <div
      id="app-container"
      class="max-w-4xl mx-auto"
      style="visibility: hidden"
    >
      <header class="flex items-center w-full mt-4 mb-6">
        <div class="flex items-center gap-2">
          <a
            id="back-link"
            href="tr/"
            class="p-1.5 rounded-lg focus:outline-none focus:ring-2 focus:ring-white/50"
            title="Geri"
            aria-label="Geri"
          >
            <span
              class="w-6 h-6 inline-flex items-center justify-center text-3xl"
              aria-hidden="true"
              >&larr;</span
            >
          </a>
          <img
            src="/icons/logo.svg?v=66"
            alt="Prompter logo"
            class="w-12 h-12 sm:w-14 sm:h-14"
          />
          <h1 class="text-xl sm:text-2xl font-bold leading-tight ml-1">
            Space
          </h1>
        </div>
      </header>
      <div class="mb-4">
        <textarea
          id="blog-input"
          class="w-full p-2 rounded-md bg-black/30"
          rows="3"
          placeholder="Bir şeyler yaz..."
        ></textarea>
        <button
          id="post-btn"
          class="mt-2 px-3 py-1 rounded-lg bg-white/20 hover:bg-white/30 transition-all"
        >
          Gönder
        </button>
      </div>
      <div id="blog-list" class="space-y-4"></div>
    </div>
    <script type="module">
      import {
        createPost,
        likePost,
        unlikePost,
        sharePostByUser,
        unsharePostByUser,
        addComment,
        getComments,
        deletePost,
        updatePostText,
      } from './src/blog.js';
      import { getUserProfile } from './src/user.js';
      import { onAuth } from './src/auth.js';
      import { appState } from './src/state.js';
      import {
        collection,
        query,
        orderBy,
        onSnapshot,
      } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
      import { db } from './src/firebase.js';

      const profileCache = {};
      const fetchName = async (uid) => {
        if (profileCache[uid]) return profileCache[uid];
        const prof = await getUserProfile(uid);
        const name = prof?.name || 'Unknown User';
        profileCache[uid] = name;
        return name;
      };

      const createCard = async (p, name, comments) => {
        const card = document.createElement('div');
        card.dataset.id = p.id;
        card.className =
          'bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/20 shadow-lg';

        const text = document.createElement('p');
        text.textContent = p.text;
        card.appendChild(text);

        const nameEl = document.createElement('p');
        nameEl.className = 'text-blue-200 text-xs mt-1 underline';
        nameEl.innerHTML = `<a href="user.html?uid=${p.userId}">${name}</a>`;
        card.appendChild(nameEl);

        const likeRow = document.createElement('div');
        likeRow.className = 'flex items-center gap-2 mt-2';

        const likeBtn = document.createElement('button');
        likeBtn.className =
          'like-btn p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all focus:outline-none focus:ring-2 focus:ring-white/50';
        likeBtn.innerHTML =
          '<i data-lucide="heart" class="w-4 h-4" aria-hidden="true"></i>';

        let likes = p.likes || 0;
        const likeCount = document.createElement('span');
        likeCount.className = 'text-xs';
        likeCount.textContent = likes.toString();

        if (
          p.likedBy &&
          appState?.currentUser &&
          p.likedBy.includes(appState.currentUser.uid)
        ) {
          likeBtn.classList.add('active');
        }

        const updateLikeIcon = () => {
          const svg = likeBtn.querySelector('svg');
          if (svg)
            svg.setAttribute(
              'fill',
              likeBtn.classList.contains('active') ? 'currentColor' : 'none'
            );
        };
        updateLikeIcon();

        likeBtn.addEventListener('click', async () => {
          if (!appState?.currentUser) {
            alert('Giriş gerekli');
            return;
          }
          likeBtn.disabled = true;
          const already = likeBtn.classList.contains('active');
          try {
            if (already) {
              await unlikePost(p.id, appState.currentUser.uid);
              likes -= 1;
              likeBtn.classList.remove('active');
            } else {
              await likePost(p.id, appState.currentUser.uid);
              likes += 1;
              likeBtn.classList.add('active');
            }
            likeCount.textContent = likes.toString();
            updateLikeIcon();
          } finally {
            likeBtn.disabled = false;
          }
        });

        const commentToggleBtn = document.createElement('button');
        commentToggleBtn.className =
          'p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all focus:outline-none focus:ring-2 focus:ring-white/50';
        commentToggleBtn.innerHTML =
          '<i data-lucide="message-circle" class="w-4 h-4" aria-hidden="true"></i>';
        const commentCount = document.createElement('span');
        commentCount.className = 'text-xs';
        let commentNum = comments.length;
        commentCount.textContent = commentNum.toString();

        const commentContainer = document.createElement('div');
        commentContainer.className = 'flex items-center gap-1';
        commentContainer.appendChild(commentToggleBtn);
        commentContainer.appendChild(commentCount);

        likeRow.appendChild(likeBtn);
        likeRow.appendChild(likeCount);
        likeRow.appendChild(commentContainer);
        if (appState?.currentUser && appState.currentUser.uid === p.userId) {
          const editBtn = document.createElement('button');
          editBtn.className =
            'p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all focus:outline-none focus:ring-2 focus:ring-white/50';
          editBtn.innerHTML =
            '<i data-lucide="pencil" class="w-4 h-4" aria-hidden="true"></i>';

          text.addEventListener('click', () => {
            if (appState.currentUser && p.userId === appState.currentUser.uid) {
              editBtn.click();
            }
          });

          editBtn.addEventListener('click', () => {
            const textarea = document.createElement('textarea');
            textarea.className = 'w-full p-2 rounded-md bg-black/30';
            textarea.value = p.text;
            card.replaceChild(textarea, text);

            const editRow = document.createElement('div');
            editRow.className = 'flex items-center gap-2 mt-2';
            const saveEdit = document.createElement('button');
            saveEdit.className =
              'p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all focus:outline-none focus:ring-2 focus:ring-white/50';
            saveEdit.innerHTML =
              '<i data-lucide="save" class="w-4 h-4" aria-hidden="true"></i>';
            const cancelEdit = document.createElement('button');
            cancelEdit.className =
              'p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all focus:outline-none focus:ring-2 focus:ring-white/50';
            cancelEdit.innerHTML =
              '<i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>';
            editRow.appendChild(saveEdit);
            editRow.appendChild(cancelEdit);

            card.replaceChild(editRow, likeRow);
            window.lucide?.createIcons();

            cancelEdit.addEventListener('click', () => {
              card.replaceChild(text, textarea);
              card.replaceChild(likeRow, editRow);
            });

            saveEdit.addEventListener('click', async () => {
              saveEdit.disabled = true;
              try {
                await updatePostText(p.id, textarea.value);
                p.text = textarea.value;
                text.textContent = textarea.value;
                cancelEdit.click();
              } catch (err) {
                console.error('Failed to update text:', err);
                saveEdit.disabled = false;
              }
            });
          });

          const delBtn = document.createElement('button');
          delBtn.className =
            'delete-post p-1.5 rounded-lg bg-white/20 hover:bg-white/30 transition-all focus:outline-none focus:ring-2 focus:ring-white/50';
          delBtn.innerHTML =
            '<i data-lucide="trash" class="w-4 h-4" aria-hidden="true"></i>';
          delBtn.addEventListener('click', async () => {
            delBtn.disabled = true;
            try {
              await deletePost(p.id);
              card.classList.add('fade-out');
              setTimeout(() => card.remove(), 300);
            } catch (err) {
              console.error('Failed to delete post:', err);
              delBtn.disabled = false;
            }
          });
          likeRow.appendChild(editBtn);
          likeRow.appendChild(delBtn);
        }
        card.appendChild(likeRow);

        const commentsWrap = document.createElement('div');
        commentsWrap.className = 'mt-2 space-y-1 hidden';
        const commentList = document.createElement('div');
        commentsWrap.appendChild(commentList);
        const commentForm = document.createElement('form');
        commentForm.className = 'flex items-center gap-2 mt-1';
        const commentInput = document.createElement('input');
        commentInput.type = 'text';
        commentInput.placeholder = 'Yorum ekle...';
        commentInput.className = 'flex-1 p-1 rounded-md bg-black/30';
        const commentBtn = document.createElement('button');
        commentBtn.type = 'submit';
        commentBtn.className =
          'px-2 py-1 rounded-lg bg-white/20 hover:bg-white/30 transition-all';
        commentBtn.innerHTML =
          '<i data-lucide="send" class="w-4 h-4" aria-hidden="true"></i>';
        commentForm.appendChild(commentInput);
        commentForm.appendChild(commentBtn);
        commentsWrap.appendChild(commentForm);
        card.appendChild(commentsWrap);

        commentToggleBtn.addEventListener('click', () => {
          commentsWrap.classList.toggle('hidden');
        });

        const renderComment = async (c) => {
          const n = await fetchName(c.userId);
          const d = document.createElement('div');
          d.className = 'bg-white/5 rounded-md px-2 py-1 text-sm';
          d.innerHTML = `<span class="underline">${n}</span>: ${c.text}`;
          commentList.appendChild(d);
        };
        for (const c of comments) {
          await renderComment(c);
        }
        commentForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!appState?.currentUser) {
            alert('Giriş gerekli');
            return;
          }
          const textVal = commentInput.value.trim();
          if (!textVal) return;
          commentBtn.disabled = true;
          try {
            await addComment(p.id, appState.currentUser.uid, textVal);
            await renderComment({
              text: textVal,
              userId: appState.currentUser.uid,
            });
            commentNum += 1;
            commentCount.textContent = commentNum.toString();
            commentInput.value = '';
          } finally {
            commentBtn.disabled = false;
          }
        });

        return card;
      };

      const blogInput = document.getElementById('blog-input');
      const postBtn = document.getElementById('post-btn');
      postBtn?.addEventListener('click', async () => {
        if (!appState?.currentUser) {
          alert('Giriş gerekli');
          return;
        }
        const text = blogInput.value.trim();
        if (!text) return;
        postBtn.disabled = true;
        try {
          await createPost(
            text,
            appState.currentUser.uid,
            appState.currentUser.displayName || '',
            appState.currentUser.email || ''
          );
          blogInput.value = '';
        } finally {
          postBtn.disabled = false;
        }
      });

      let unsubscribe = null;
      const startListener = () => {
        if (unsubscribe) unsubscribe();
        const q = query(
          collection(db, 'blogPosts'),
          orderBy('createdAt', 'desc')
        );
        unsubscribe = onSnapshot(q, async (snap) => {
          const posts = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
          const names = await Promise.all(
            posts.map((p) => fetchName(p.userId))
          );
          const commentsArr = await Promise.all(
            posts.map((p) => getComments(p.id))
          );
          const list = document.getElementById('blog-list');
          list.innerHTML = '';
          for (let i = 0; i < posts.length; i++) {
            const card = await createCard(posts[i], names[i], commentsArr[i]);
            list.appendChild(card);
          }
          window.lucide?.createIcons();
        });
      };

      document.addEventListener('DOMContentLoaded', () => {
        onAuth(startListener);
        startListener();
      });
    </script>
  </body>
</html>
